<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Documents | Retirement Home</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Base styles aligning with index.html design -->
  <style>
    :root{
      --bg:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --brand:#0ea5e9;
      --brand-600:#0284c7;
      --surface:#f3f4f6;
      --border:#e5e7eb;
      --radius:12px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Apple Color Emoji, Segoe UI Emoji;
      line-height:1.5;
    }
    header{
      position:sticky; top:0; z-index:20;
      background:rgba(255,255,255,0.8);
      backdrop-filter: saturate(180%) blur(12px);
      border-bottom:1px solid var(--border);
    }
    .container{max-width:1100px; margin:0 auto; padding:0 20px;}
    .nav{
      display:flex; align-items:center; justify-content:space-between; height:64px;
    }
    .nav a.logo{
      display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text); font-weight:700; font-size:18px;
    }
    .nav .links a{
      margin-left:16px; text-decoration:none; color:var(--text); font-weight:500;
    }
    .hero{
      padding:40px 0 12px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(180deg, #f9fafb 0%, #ffffff 100%);
    }
    .hero h1{ margin:0 0 8px; font-size:28px; }
    .hero p{ margin:0; color:var(--muted); }
    main{ padding:24px 0 60px; }
    .layout{
      display:grid; grid-template-columns:280px 1fr; gap:20px;
    }
    @media (max-width: 900px){
      .layout{ grid-template-columns:1fr; }
    }

    /* Sidebar tree and search */
    .panel{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:12px;
    }
    .search{
      position:relative; margin-bottom:8px;
    }
    .search input{
      width:100%; padding:10px 36px 10px 12px;
      border:1px solid var(--border); border-radius:10px; background:#fff;
      outline:none;
    }
    .search .icon{
      position:absolute; right:10px; top:50%; transform:translateY(-50%); color:var(--muted);
      pointer-events:none;
    }
    .tree{
      max-height:60vh; overflow:auto; padding:4px;
    }
    .tree ul{ list-style:none; margin:0; padding-left:14px; }
    .tree li{
      margin:2px 0; padding:4px 6px; border-radius:8px; cursor:pointer;
      display:flex; align-items:center; gap:6px;
    }
    .tree li:hover{ background:#fff; }
    .tree .label{ flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .disclosure{
      width:18px; height:18px; display:inline-flex; align-items:center; justify-content:center;
      border-radius:4px; color:var(--muted);
    }
    .disclosure.open{ color:var(--brand); }
    .active{ background:#e0f2fe !important; color:#0c4a6e; }

    /* Content area */
    .content{
      background:#fff; border:1px solid var(--border); border-radius:var(--radius); padding:16px;
      min-height:420px;
    }
    .crumbs{
      font-size:14px; color:var(--muted); margin-bottom:8px;
    }
    .content h2{ margin:6px 0 14px; font-size:22px; }
    .file-grid{
      display:grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap:14px;
    }
    .card{
      border:1px solid var(--border); border-radius:12px; padding:12px; background:var(--surface);
      display:flex; gap:10px; align-items:flex-start;
    }
    .file-icon{
      width:42px; height:42px; border-radius:10px; background:#dbeafe; color:#1d4ed8;
      display:flex; align-items:center; justify-content:center; font-weight:700;
      flex:0 0 auto;
    }
    .meta{ flex:1; min-width:0; }
    .meta .title{ font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .meta .desc{ font-size:12px; color:var(--muted); }
    .actions{
      display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;
    }
    .btn{
      display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:10px;
      border:1px solid var(--border); background:#fff; color:var(--text); text-decoration:none; cursor:pointer;
      font-size:14px;
    }
    .btn.primary{ background:var(--brand); color:#fff; border-color:var(--brand-600); }
    .empty{
      text-align:center; color:var(--muted); padding:40px 0;
    }
    footer{
      border-top:1px solid var(--border); padding:24px 0; color:var(--muted); font-size:14px;
    }
    .tag{
      display:inline-block; font-size:11px; background:#eef2ff; color:#3730a3; padding:2px 6px; border-radius:999px;
      margin-left:6px;
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <nav class="nav">
        <a href="index.html" class="logo">
          <span aria-hidden="true">üè°</span> <span>Retirement Home</span>
        </a>
        <div class="links">
          <a href="index.html">Home</a>
          <a href="documents.html" style="color:var(--brand)">Documents</a>
          <a href="admin.html">Staff Login</a>
        </div>
      </nav>
    </div>
  </header>

  <section class="hero">
    <div class="container">
      <h1>Documents</h1>
      <p>Browse and download important documents. Use the categories on the left or search.</p>
    </div>
  </section>

  <main class="container">
    <div class="layout">
      <aside class="panel">
        <div class="search">
          <input id="searchInput" placeholder="Search documents or categories..." />
          <span class="icon">üîé</span>
        </div>
        <div id="tree" class="tree" role="tree" aria-label="Document categories"></div>
      </aside>

      <section class="content" id="content">
        <div class="crumbs" id="breadcrumbs"></div>
        <h2 id="categoryTitle">All Documents</h2>
        <div class="file-grid" id="fileGrid"></div>
        <div class="empty" id="emptyState" style="display:none;">No documents found in this category.</div>
      </section>
    </div>
  </main>

  <footer>
    <div class="container">
      ¬© <span id="year"></span> Retirement Home. All rights reserved.
    </div>
  </footer>

  <script>
    // Configuration placeholders
    const JSONBIN_BIN_ID = "68b9d3d8d0ea881f4071c182";
    // Public GET does not require Master-Key if bin is public-read. If not, you can add a read key here.
    const JSONBIN_READ_HEADERS = {
      "Content-Type": "application/json"
      "X-Master-Key": "$2a$10$9sO/ja29sMebpWNvsWmp5.dJ6lv7CPeLBMRFaA/cAEwz42ii6qlCS" // Only if needed for read
    };

    // Basic expected JSON structure in JSONBin:
    // {
    //   "name": "Root",
    //   "id": "root",
    //   "children": [
    //     {"id":"cat-1","name":"Admissions","children":[ ... ],"files":[...]}
    //   ],
    //   "files":[
    //     {"id":"file-1","name":"Welcome Packet","description":"...","tags":["pdf"],"url":"https://...","size":12345,"updated":"2025-01-01"}
    //   ]
    // }

    let rootData = null;
    let activePath = []; // array of category ids from root to current
    let filteredText = "";

    document.getElementById('year').textContent = new Date().getFullYear();

    async function fetchDocuments() {
      const res = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`, { headers: JSONBIN_READ_HEADERS });
      if (!res.ok) throw new Error("Failed to load documents");
      const data = await res.json();
      return data.record;
    }

    function buildTreeNode(cat, level=0) {
      const li = document.createElement('li');
      li.setAttribute('role','treeitem');
      li.setAttribute('aria-level', String(level+1));
      li.dataset.id = cat.id;

      const hasChildren = (cat.children && cat.children.length) || false;

      const disclosure = document.createElement('span');
      disclosure.className = 'disclosure';
      disclosure.textContent = hasChildren ? '‚ñ∏' : '¬∑';
      li.appendChild(disclosure);

      const label = document.createElement('span');
      label.className = 'label';
      label.textContent = cat.name;
      li.appendChild(label);

      if (filteredText && !matchesFilter(cat)) {
        li.style.display = 'none';
      }

      if (hasChildren) {
        const ul = document.createElement('ul');
        ul.setAttribute('role','group');
        cat.children.forEach(ch => ul.appendChild(buildTreeNode(ch, level+1)));
        ul.style.display = 'none';
        li.appendChild(ul);

        li.addEventListener('click', (e)=>{
          if (e.target === disclosure || e.target === label || e.currentTarget === li) {
            const open = ul.style.display !== 'none';
            ul.style.display = open ? 'none' : 'block';
            disclosure.textContent = open ? '‚ñ∏' : '‚ñæ';
            disclosure.classList.toggle('open', !open);
            setActiveCategory(cat.id);
            e.stopPropagation();
          }
        });
      } else {
        li.addEventListener('click', (e)=>{
          setActiveCategory(cat.id);
          e.stopPropagation();
        });
      }

      return li;
    }

    function matchesFilter(catOrFile) {
      const q = filteredText.toLowerCase().trim();
      if (!q) return true;
      if (catOrFile.name && catOrFile.name.toLowerCase().includes(q)) return true;
      if (catOrFile.description && catOrFile.description.toLowerCase().includes(q)) return true;
      if (catOrFile.tags && catOrFile.tags.join(' ').toLowerCase().includes(q)) return true;
      return false;
    }

    function findCategoryById(cat, id, path=[]) {
      if (!cat) return null;
      if (cat.id === id) return { node: cat, path: [...path, cat] };
      if (cat.children) {
        for (const c of cat.children) {
          const result = findCategoryById(c, id, [...path, cat]);
          if (result) return result;
        }
      }
      return null;
    }

    function renderTree() {
      const tree = document.getElementById('tree');
      tree.innerHTML = '';
      const ul = document.createElement('ul');
      ul.setAttribute('role','tree');
      ul.style.paddingLeft = '2px';
      ul.appendChild(buildTreeNode(rootData, 0));
      tree.appendChild(ul);

      // Auto-expand along activePath
      if (activePath.length > 0) {
        const ids = activePath.map(c=>c.id);
        tree.querySelectorAll('li').forEach(li=>{
          const id = li.dataset.id;
          if (ids.includes(id)) {
            const ulChild = li.querySelector(':scope > ul');
            const disclosure = li.querySelector(':scope > .disclosure');
            if (ulChild) {
              ulChild.style.display = 'block';
              disclosure.textContent = '‚ñæ';
              disclosure.classList.add('open');
            }
            li.classList.add('active');
          } else {
            li.classList.remove('active');
          }
        });
      }
    }

    function renderContent(cat) {
      const crumbsEl = document.getElementById('breadcrumbs');
      const titleEl = document.getElementById('categoryTitle');
      const fileGrid = document.getElementById('fileGrid');
      const emptyState = document.getElementById('emptyState');

      // Breadcrumbs
      const crumbs = activePath.map(c=>c.name);
      crumbsEl.textContent = crumbs.length ? crumbs.join(' ‚Ä∫ ') : 'All Documents';

      titleEl.textContent = cat ? cat.name : 'All Documents';

      // Files: collect from current cat only
      let files = (cat && cat.files) ? cat.files.slice() : (rootData.files || []).slice();

      // Also include descendant files if searching
      if (filteredText) {
        // Flatten all files under this node
        files = gatherFiles(cat || rootData).filter(matchesFilter);
      }

      // If a filter is active but we're at root, also show category matches as "virtual items"
      if (filteredText && (!cat || cat.id === 'root')) {
        const catMatches = gatherCategories(rootData).filter(matchesFilter);
        // Not rendering categories as cards here; tree already filtered. Optional: render shortcuts.
      }

      fileGrid.innerHTML = '';

      if (!files || files.length === 0) {
        emptyState.style.display = 'block';
        return;
      }

      emptyState.style.display = 'none';

      files.forEach(f=>{
        const card = document.createElement('div');
        card.className = 'card';
        const icon = document.createElement('div');
        icon.className = 'file-icon';
        icon.textContent = 'PDF';
        const meta = document.createElement('div');
        meta.className = 'meta';

        const title = document.createElement('div');
        title.className = 'title';
        title.title = f.name;
        title.textContent = f.name;

        const desc = document.createElement('div');
        desc.className = 'desc';
        const parts = [];
        if (f.description) parts.push(f.description);
        if (f.size) parts.push(formatSize(f.size));
        if (f.updated) parts.push(new Date(f.updated).toLocaleDateString());
        desc.textContent = parts.join(' ‚Ä¢ ');

        const actions = document.createElement('div');
        actions.className = 'actions';
        const viewBtn = document.createElement('a');
        viewBtn.className = 'btn primary';
        viewBtn.href = f.url;
        viewBtn.target = '_blank';
        viewBtn.rel = 'noopener';
        viewBtn.textContent = 'View';
        const dlBtn = document.createElement('a');
        dlBtn.className = 'btn';
        dlBtn.href = f.url;
        dlBtn.download = '';
        dlBtn.textContent = 'Download';

        actions.appendChild(viewBtn);
        actions.appendChild(dlBtn);

        meta.appendChild(title);
        if (f.tags && f.tags.length) {
          const tags = document.createElement('div');
          f.tags.forEach(t=>{
            const span = document.createElement('span');
            span.className = 'tag';
            span.textContent = t;
            tags.appendChild(span);
          });
          meta.appendChild(tags);
        }
        meta.appendChild(desc);
        meta.appendChild(actions);

        card.appendChild(icon);
        card.appendChild(meta);
        fileGrid.appendChild(card);
      });
    }

    function setActiveCategory(id) {
      const found = findCategoryById(rootData, id) || { node: rootData, path:[rootData] };
      activePath = found.path;
      renderTree();
      renderContent(found.node);
    }

    function gatherFiles(cat){
      let files = [];
      if (cat.files) files = files.concat(cat.files);
      if (cat.children) cat.children.forEach(ch => { files = files.concat(gatherFiles(ch)); });
      return files;
    }

    function gatherCategories(cat){
      let cats = [cat];
      if (cat.children) cat.children.forEach(ch => { cats = cats.concat(gatherCategories(ch)); });
      return cats;
    }

    function formatSize(bytes){
      if (!bytes && bytes !== 0) return '';
      const units=['B','KB','MB','GB'];
      let i=0; let b=bytes;
      while (b>=1024 && i<units.length-1){ b/=1024; i++; }
      return b.toFixed(b<10 && i>0?1:0)+' '+units[i];
    }

    function applySearch(q){
      filteredText = q || '';
      // Rebuild tree to apply label filtering
      renderTree();
      // Keep current active category
      const current = activePath.length ? activePath[activePath.length-1] : rootData;
      renderContent(current);
    }

    // Initialize
    (async function init(){
      try {
        const data = await fetchDocuments();
        // Ensure defaults
        if (!data.id) data.id = 'root';
        if (!data.name) data.name = 'Documents';
        if (!data.children) data.children = [];
        if (!data.files) data.files = [];

        rootData = data;
        activePath = [rootData];
        renderTree();
        renderContent(rootData);

        const searchInput = document.getElementById('searchInput');
        searchInput.addEventListener('input', (e)=> applySearch(e.target.value));

      } catch (e) {
        document.getElementById('content').innerHTML = '<div class="empty">Unable to load documents at this time.</div>';
        console.error(e);
      }
    })();
  </script>
</body>
</html>
