<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Documents | Evergreen Retirement Home</title>
<meta name="description" content="Browse and download documents from Evergreen Retirement Home." />
<style>
  :root{
    --bg:#f8fafc;
    --panel:#ffffff;
    --text:#0f172a;
    --muted:#475569;
    --accent:#2563eb;
    --accent-2:#1e40af;
    --border:#e2e8f0;
    --success:#16a34a;
    --warn:#b45309;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    color:var(--text);
    background:var(--bg);
  }
  header{
    background:linear-gradient(180deg,#0b3b2e,#0e4a3a);
    color:#fff;
    padding:18px 20px;
  }
  header .wrap{
    max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:20px;justify-content:space-between;
  }
  .brand{display:flex;align-items:center;gap:12px}
  .brand-logo{
    width:40px;height:40px;border-radius:8px;background:#e8f5ee;border:2px solid #c9e6d7;display:grid;place-items:center;color:#0b3b2e;font-weight:700
  }
  nav a{
    color:#e6ffef;text-decoration:none;margin:0 10px;font-weight:600;opacity:.9
  }
  nav a:hover{opacity:1;text-decoration:underline}
  .hero{
    background:#0e4a3a;color:#d6f5e6;border-top:1px solid rgba(255,255,255,.15);border-bottom:1px solid rgba(255,255,255,.15)
  }
  .hero .wrap{max-width:1200px;margin:0 auto;padding:18px 20px}
  .hero h1{margin:0 0 6px 0;font-size:24px}
  .hero p{margin:0;color:#cde9dd}
  main{max-width:1200px;margin:16px auto;padding:0 20px 40px 20px}
  .layout{display:grid;grid-template-columns:240px 320px 1fr;gap:16px}
  @media (max-width: 1024px){.layout{grid-template-columns:1fr}}
  .panel{
    background:var(--panel);border:1px solid var(--border);border-radius:12px;overflow:hidden
  }
  .panel .head{
    padding:12px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;justify-content:space-between
  }
  .panel .body{padding:10px}
  .searchbar{display:flex;gap:8px}
  .searchbar input{
    flex:1;padding:10px 12px;border:1px solid var(--border);border-radius:8px
  }
  .searchbar button{
    padding:10px 12px;border:none;border-radius:8px;background:var(--accent);color:#fff;font-weight:600;cursor:pointer
  }
  .searchbar button:hover{background:var(--accent-2)}
  .list{
    display:flex;flex-direction:column
  }
  .item{
    padding:10px 12px;border-bottom:1px solid var(--border);cursor:pointer;display:flex;justify-content:space-between;align-items:center;gap:8px
  }
  .item:hover{background:#f1f5f9}
  .item.active{background:#e8f0ff;border-left:3px solid var(--accent)}
  .muted{color:var(--muted);font-size:13px}
  .grid{
    display:grid;grid-template-columns:1fr 1fr;gap:10px
  }
  @media (max-width: 640px){.grid{grid-template-columns:1fr}}
  .file{
    border:1px solid var(--border);border-radius:10px;padding:10px;background:#fff;display:flex;flex-direction:column;gap:6px
  }
  .file .title{font-weight:700}
  .file .meta{font-size:12px;color:var(--muted);display:flex;gap:12px;flex-wrap:wrap}
  .file .actions{display:flex;gap:8px}
  .btn{
    padding:8px 10px;border:1px solid var(--border);border-radius:8px;background:#fff;cursor:pointer;font-weight:600
  }
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .btn.primary:hover{background:var(--accent-2);border-color:var(--accent-2)}
  .empty{
    padding:16px;border:1px dashed var(--border);border-radius:10px;background:#fafcff;color:var(--muted);text-align:center
  }
  footer{max-width:1200px;margin:20px auto 40px auto;padding:0 20px;color:var(--muted);font-size:13px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">
      <div class="brand-logo">E</div>
      <div>
        <div style="font-weight:800;">Evergreen Retirement Home</div>
        <div style="font-size:12px;opacity:.85">Warmth. Care. Community.</div>
      </div>
    </div>
    <nav>
      <a href="index.html">Home</a>
      <a href="documents.html" style="text-decoration:underline">Documents</a>
      <a href="admin.html">Staff Admin</a>
    </nav>
  </div>
</header>
<section class="hero">
  <div class="wrap">
    <h1>Documents</h1>
    <p>Browse policies, newsletters, notices, forms, and more. Click a file to view or download.</p>
  </div>
</section>

<main>
  <div class="panel" style="margin-bottom:16px">
    <div class="head">
      <div class="muted">Search documents</div>
    </div>
    <div class="body">
      <div class="searchbar">
        <input id="searchInput" type="search" placeholder="Search by title or filename..." />
        <button id="searchBtn">Search</button>
      </div>
    </div>
  </div>

  <div class="layout">
    <div class="panel" id="catsPanel">
      <div class="head"><div>Categories</div></div>
      <div class="body">
        <div id="catsList" class="list"></div>
      </div>
    </div>

    <div class="panel" id="subsPanel">
      <div class="head"><div>Subcategories</div></div>
      <div class="body">
        <div id="subsList" class="list"></div>
      </div>
    </div>

    <div class="panel" id="filesPanel">
      <div class="head"><div id="filesTitle">Files</div></div>
      <div class="body">
        <div id="filesGrid" class="grid"></div>
        <div id="emptyState" class="empty" style="display:none">No files found.</div>
      </div>
    </div>
  </div>
</main>

<footer>
  © <span id="year"></span> Evergreen Retirement Home — For questions about documents, please contact our front desk.
</footer>

<script>
  const BIN_ID = "68b9d3d8d0ea881f4071c182";
  const JSONBIN_READ_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}/latest`;
  const state = {
    data: null,
    selectedCatId: null,
    selectedSubId: null,
    search: ""
  };

  const schema = () => ({
    version: 1,
    lastUpdated: new Date().toISOString(),
    categories: []
  });

  async function fetchData() {
    const res = await fetch(JSONBIN_READ_URL, { headers: { "X-Bin-Meta": "false" }});
    if (!res.ok) throw new Error("Failed to load documents");
    const data = await res.json();
    // JSONBin returns stored object or wrapper depending on write method; guard both
    return data.record ? data.record : data;
  }

  function renderCategories() {
    const el = document.getElementById("catsList");
    el.innerHTML = "";
    const cats = state.data.categories || [];
    if (cats.length === 0) {
      el.innerHTML = `<div class="empty">No categories yet.</div>`;
      document.getElementById("subsList").innerHTML = "";
      document.getElementById("filesGrid").innerHTML = "";
      document.getElementById("emptyState").style.display = "block";
      return;
    }
    cats.forEach(cat => {
      const div = document.createElement("div");
      div.className = "item" + (cat.id === state.selectedCatId ? " active" : "");
      div.innerHTML = `<div>
        <div style="font-weight:700">${escapeHtml(cat.name)}</div>
        <div class="muted">${escapeHtml(cat.description || "")}</div>
      </div>`;
      div.onclick = () => {
        state.selectedCatId = cat.id;
        state.selectedSubId = null;
        renderCategories();
        renderSubcategories();
        renderFiles();
      };
      el.appendChild(div);
    });
  }

  function renderSubcategories() {
    const el = document.getElementById("subsList");
    el.innerHTML = "";
    const cat = (state.data.categories || []).find(c => c.id === state.selectedCatId);
    if (!cat) {
      el.innerHTML = `<div class="empty">Select a category to view subcategories.</div>`;
      return;
    }
    const subs = cat.subcategories || [];
    if (subs.length === 0) {
      el.innerHTML = `<div class="empty">No subcategories.</div>`;
      return;
    }
    subs.forEach(sub => {
      const div = document.createElement("div");
      div.className = "item" + (sub.id === state.selectedSubId ? " active" : "");
      const totalFiles = (sub.lists || []).reduce((n, lst) => n + (lst.files?.length || 0), 0);
      div.innerHTML = `<div>
        <div style="font-weight:700">${escapeHtml(sub.name)}</div>
        <div class="muted">${totalFiles} file(s) across ${sub.lists?.length || 0} list(s)</div>
      </div>`;
      div.onclick = () => {
        state.selectedSubId = sub.id;
        renderSubcategories();
        renderFiles();
      };
      el.appendChild(div);
    });
  }

  function searchFilesAcrossAll() {
    const q = state.search.trim().toLowerCase();
    const results = [];
    for (const cat of state.data.categories || []) {
      for (const sub of cat.subcategories || []) {
        for (const lst of sub.lists || []) {
          for (const f of lst.files || []) {
            const hay = `${f.title||""} ${f.filename||""}`.toLowerCase();
            if (!q || hay.includes(q)) {
              results.push({ cat, sub, lst, file: f });
            }
          }
        }
      }
    }
    return results;
  }

  function renderFiles() {
    const grid = document.getElementById("filesGrid");
    const empty = document.getElementById("emptyState");
    grid.innerHTML = "";
    let files = [];
    let title = "Files";
    const q = state.search.trim();
    if (q) {
      files = searchFilesAcrossAll();
      title = `Search results for "${escapeHtml(q)}"`;
    } else if (state.selectedCatId && state.selectedSubId) {
      const cat = state.data.categories.find(c => c.id === state.selectedCatId);
      const sub = (cat?.subcategories || []).find(s => s.id === state.selectedSubId);
      if (sub) {
        for (const lst of sub.lists || []) {
          for (const file of lst.files || []) {
            files.push({ cat, sub, lst, file });
          }
        }
        title = `${sub.name} — Files`;
      }
    } else if (state.selectedCatId) {
      const cat = state.data.categories.find(c => c.id === state.selectedCatId);
      for (const sub of cat?.subcategories || []) {
        for (const lst of sub.lists || []) {
          for (const file of lst.files || []) files.push({ cat, sub, lst, file });
        }
      }
      title = `${cat?.name || "Files"}`;
    } else {
      files = searchFilesAcrossAll();
      title = "All files";
    }
    document.getElementById("filesTitle").textContent = title;

    if (files.length === 0) {
      empty.style.display = "block";
      return;
    }
    empty.style.display = "none";

    files.sort((a,b)=> (a.file.title||"").localeCompare(b.file.title||""));

    for (const row of files) {
      const { file, lst, sub, cat } = row;
      const card = document.createElement("div");
      card.className = "file";
      const size = file.sizeBytes ? humanFileSize(file.sizeBytes) : "";
      const uploaded = file.uploadedAt ? new Date(file.uploadedAt).toLocaleString() : "";
      card.innerHTML = `
        <div class="title">📄 ${escapeHtml(file.title || file.filename || "Untitled")}</div>
        <div class="meta">
          <span>${escapeHtml(cat.name)} › ${escapeHtml(sub.name)} › ${escapeHtml(lst.name)}</span>
          ${size ? `<span>${size}</span>`:""}
          ${uploaded ? `<span>${uploaded}</span>`:""}
        </div>
        <div class="actions">
          <a class="btn primary" href="${file.url}" target="_blank" rel="noopener">View</a>
          <a class="btn" href="${file.url}" download>Download</a>
        </div>
      `;
      grid.appendChild(card);
    }
  }

  // Utils
  function humanFileSize(bytes){
    const thresh=1024;if(Math.abs(bytes)<thresh)return bytes+" B";
    const units=["KB","MB","GB","TB"];let u=-1;do{bytes/=thresh;++u}while(Math.abs(bytes)>=thresh&&u<units.length-1);
    return bytes.toFixed(1)+" "+units[u];
  }
  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // Events
  document.getElementById("searchBtn").onclick = ()=>{
    state.search = document.getElementById("searchInput").value;
    renderFiles();
  };
  document.getElementById("searchInput").addEventListener("keydown", e=>{
    if(e.key==="Enter"){ document.getElementById("searchBtn").click(); }
  });

  // Init
  document.getElementById("year").textContent = new Date().getFullYear();
  (async ()=>{
    try{
      const data = await fetchData();
      state.data = data && data.categories ? data : schema();
    }catch(e){
      console.error(e);
      state.data = schema();
    }
    renderCategories();
    renderSubcategories();
    renderFiles();
  })();
</script>
</body>
</html>
