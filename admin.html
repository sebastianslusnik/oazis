<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Oazis File Manager</title>
	<script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>
	<style>
	:root {
		--bg: #f7f7f7;
		--panel: #ffffff;
		--text: #222;
		--muted: #888;
		--border: #e5e5e5;
		--accent: #333;
	}

	* {
		box-sizing: border-box;
	}

	body {
		margin: 0;
		background: var(--bg);
		color: var(--text);
		font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
	}

	header {
		padding: 12px 16px;
		border-bottom: 1px solid var(--border);
		background: var(--panel);
		display: flex;
		align-items: center;
		gap: 8px;
	}

	header h1 {
		margin: 0;
		font-size: 16px;
		font-weight: 600;
		letter-spacing: .2px;
	}

	.app {
		display: flex;
		height: calc(100vh - 50px);
	}

	.left {
		width: 280px;
		min-width: 240px;
		max-width: 360px;
		border-right: 1px solid var(--border);
		background: var(--panel);
		display: flex;
		flex-direction: column;
	}

	.left .toolbar {
		padding: 10px;
		border-bottom: 1px solid var(--border);
		display: flex;
		gap: 8px;
	}

	.left .toolbar input {
		flex: 1;
		padding: 8px;
		border: 1px solid var(--border);
		border-radius: 6px;
		background: white;
	}

	.left .toolbar button {
		padding: 8px 10px;
		border: 1px solid var(--border);
		background: #f2f2f2;
		color: var(--accent);
		border-radius: 6px;
		cursor: pointer;
	}

	.folders {
		overflow: auto;
		padding: 6px;
	}

	.folder {
		display: flex;
		align-items: center;
		justify-content: space-between;
		padding: 8px 10px;
		border-radius: 6px;
		cursor: pointer;
	}

	.folder:hover {
		background: #f3f3f3;
	}

	.folder.active {
		background: #eaeaea;
	}

	.folder .name {
		font-weight: 500;
	}

	.folder .actions {
		display: flex;
		gap: 6px;
		opacity: .8;
	}

	.folder .actions button {
		border: none;
		background: transparent;
		padding: 4px 6px;
		cursor: pointer;
		color: var(--muted);
	}

	.right {
		flex: 1;
		display: flex;
		flex-direction: column;
	}

	.right .toolbar {
		padding: 10px;
		border-bottom: 1px solid var(--border);
		background: var(--panel);
		display: flex;
		gap: 8px;
		align-items: center;
		flex-wrap: wrap;
	}

	select,
	input[type="text"] {
		padding: 8px;
		border: 1px solid var(--border);
		border-radius: 6px;
		background: white;
	}

	input[type="file"] {
		border: 1px dashed var(--border);
		padding: 8px;
		border-radius: 6px;
		background: white;
	}

	.right .toolbar button {
		padding: 8px 12px;
		border: 1px solid var(--border);
		background: #f2f2f2;
		color: var(--accent);
		border-radius: 6px;
		cursor: pointer;
	}

	.content {
		padding: 8px;
		overflow: auto;
	}

	table {
		width: 100%;
		border-collapse: collapse;
		background: var(--panel);
		border: 1px solid var(--border);
		border-radius: 8px;
		overflow: hidden;
	}

	th,
	td {
		padding: 10px 12px;
		border-bottom: 1px solid var(--border);
		text-align: left;
	}

	th {
		background: #fafafa;
		font-weight: 600;
		font-size: 13px;
		color: #444;
	}

	tbody tr:hover {
		background: #f9f9f9;
	}

	.muted {
		color: var(--muted);
	}

	.empty {
		padding: 16px;
		color: var(--muted);
	}

	.grow {
		flex: 1;
	}

	.status {
		margin-left: auto;
		font-size: 12px;
		color: var(--muted);
	}
	</style>
</head>

<body>
	<header>
		<h1>Oazis File Manager</h1>
		<div class="status" id="status">Ready</div>
	</header>
	<div class="app">
		<aside class="left">
			<div class="toolbar"> <input id="newFolderName" type="text" placeholder="New folder name" /> <button id="btnCreateFolder" title="Create folder">Add</button> </div>
			<div class="folders" id="foldersList"></div>
		</aside>
		<main class="right">
			<div class="toolbar">
				<div>Folder:</div> <select id="folderSelect"></select>
				<div class="grow"></div> <input type="file" id="fileInput" /> <input type="text" id="customFileId" placeholder="Optional custom File ID" /> <button id="btnUpload">Upload</button>
			</div>
			<div class="content">
				<table id="filesTable">
					<thead>
						<tr>
							<th>File Name</th>
							<th>File ID</th>
							<th>Size</th>
							<th>Created</th>
							<th>Actions</th>
						</tr>
					</thead>
					<tbody id="filesBody">
						<tr>
							<td colspan="5" class="empty">Select a folder...</td>
						</tr>
					</tbody>
				</table>
			</div>
		</main>
	</div>

	<script>
const APPWRITE_ENDPOINT = 'https://cloud.appwrite.io/v1';
const APPWRITE_PROJECT_ID = 'oazissebike';
const APPWRITE_BUCKET_ID = 'oazissebike';
const APPWRITE_API_KEY = 'standard_d58aa133fc638f7765b7f59950ec4860d5b2bc0ed9a61159d173c4cc8a5aa4968e726aa198447e264c21068e47e7bc087625947ec0b52579487c5ad775011646037bdfac41402e5cef446c143ccd5c50c4fd6e5a06ab3945ba8e78388aaf0d34930a4f26458790e656d73681d81994693de06edf9fb7de6d030ccc8e6f45a3fe';
const JSONBIN_BIN_ID = '68b9d3d8d0ea881f4071c182';
const JSONBIN_MASTER_KEY = '$2a$10$9sO/ja29sMebpWNvsWmp5.dJ6lv7CPeLBMRFaA/cAEwz42ii6qlCS';
const JSONBIN_BASE = 'https://api.jsonbin.io/v3';
let folders = [];
let activeFolderIndex = -1;
const client = new Appwrite.Client().setEndpoint(APPWRITE_ENDPOINT).setProject(APPWRITE_PROJECT_ID).setKey(APPWRITE_API_KEY);
const storage = new Appwrite.Storage(client);
const statusEl = document.getElementById('status');
const foldersListEl = document.getElementById('foldersList');
const folderSelectEl = document.getElementById('folderSelect');
const filesBodyEl = document.getElementById('filesBody');
const newFolderNameEl = document.getElementById('newFolderName');
const btnCreateFolderEl = document.getElementById('btnCreateFolder');
const fileInputEl = document.getElementById('fileInput');
const customFileIdEl = document.getElementById('customFileId');
const btnUploadEl = document.getElementById('btnUpload');

function setStatus(msg) {
	statusEl.textContent = msg;
}
async function fetchFolders() {
	setStatus('Loading folders...');
	const res = await fetch(`${JSONBIN_BASE}/b/${JSONBIN_BIN_ID}/latest`, {
		headers: {
			'X-Master-Key': JSONBIN_MASTER_KEY,
			'X-Bin-Meta': 'false',
			'Content-Type': 'application/json'
		},
		cache: 'no-store'
	});
	if(!res.ok) throw new Error('Failed to load folders');
	const data = await res.json();
	folders = Array.isArray(data.folders) ? data.folders : [];
	setStatus('Folders loaded');
}
async function saveFolders() {
	setStatus('Saving...');
	const res = await fetch(`${JSONBIN_BASE}/b/${JSONBIN_BIN_ID}`, {
		method: 'PUT',
		headers: {
			'X-Master-Key': JSONBIN_MASTER_KEY,
			'Content-Type': 'application/json'
		},
		body: JSON.stringify({
			folders
		})
	});
	if(!res.ok) throw new Error('Failed to save folders');
	setStatus('Saved');
}

function renderFoldersList() {
	foldersListEl.innerHTML = '';
	folders.forEach((f, idx) => {
		const row = document.createElement('div');
		row.className = 'folder' + (idx === activeFolderIndex ? ' active' : '');
		row.onclick = () => {
			activeFolderIndex = idx;
			renderFoldersList();
			renderFolderSelect();
			loadFilesForActiveFolder();
		};
		const name = document.createElement('div');
		name.className = 'name';
		name.textContent = f.name;
		const actions = document.createElement('div');
		actions.className = 'actions';
		const renameBtn = document.createElement('button');
		renameBtn.title = 'Rename';
		renameBtn.textContent = 'Rename';
		renameBtn.onclick = (e) => {
			e.stopPropagation();
			renameFolder(idx);
		};
		const delBtn = document.createElement('button');
		delBtn.title = 'Delete';
		delBtn.textContent = 'Delete';
		delBtn.onclick = (e) => {
			e.stopPropagation();
			deleteFolder(idx);
		};
		actions.append(renameBtn, delBtn);
		row.append(name, actions);
		foldersListEl.appendChild(row);
	});
	if(folders.length === 0) {
		const empty = document.createElement('div');
		empty.className = 'empty';
		empty.style.padding = '12px';
		empty.textContent = 'No folders. Create one.';
		foldersListEl.appendChild(empty);
	}
}

function renderFolderSelect() {
	folderSelectEl.innerHTML = '';
	folders.forEach((f, idx) => {
		const opt = document.createElement('option');
		opt.value = idx;
		opt.textContent = f.name;
		folderSelectEl.appendChild(opt);
	});
	if(activeFolderIndex >= 0 && activeFolderIndex < folders.length) {
		folderSelectEl.value = String(activeFolderIndex);
	}
	folderSelectEl.onchange = () => {
		activeFolderIndex = parseInt(folderSelectEl.value, 10);
		renderFoldersList();
		loadFilesForActiveFolder();
	};
}

function sanitizedFolderName(name) {
	return String(name || '').trim();
}
async function createFolder() {
	const name = sanitizedFolderName(newFolderNameEl.value);
	if(!name) {
		alert('Enter folder name');
		return;
	}
	if(folders.find(f => f.name.toLowerCase() === name.toLowerCase())) {
		alert('Folder already exists');
		return;
	}
	folders.push({
		name,
		files: []
	});
	await saveFolders().catch(err => alert(err.message));
	newFolderNameEl.value = '';
	activeFolderIndex = folders.length - 1;
	renderFoldersList();
	renderFolderSelect();
	loadFilesForActiveFolder();
}
async function renameFolder(idx) {
	const current = folders[idx];
	const newName = prompt('Rename folder', current.name);
	if(newName === null) return;
	const name = sanitizedFolderName(newName);
	if(!name) {
		alert('Invalid name');
		return;
	}
	if(folders.find((f, i) => i !== idx && f.name.toLowerCase() === name.toLowerCase())) {
		alert('Folder with this name already exists');
		return;
	}
	folders[idx].name = name;
	await saveFolders().catch(err => alert(err.message));
	renderFoldersList();
	renderFolderSelect();
}
async function deleteFolder(idx) {
	const f = folders[idx];
	if(f.files && f.files.length > 0) {
		alert('Folder is not empty. Remove files first.');
		return;
	}
	if(!confirm(`Delete folder "${f.name}"?`)) return;
	folders.splice(idx, 1);
	if(activeFolderIndex === idx) activeFolderIndex = -1;
	await saveFolders().catch(err => alert(err.message));
	renderFoldersList();
	renderFolderSelect();
	filesBodyEl.innerHTML = `<tr><td colspan="5" class="empty">Select a folder...</td></tr>`;
}

function formatBytes(bytes) {
	const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
	if(bytes === 0) return '0 B';
	const i = Math.floor(Math.log(bytes) / Math.log(1024));
	return (bytes / Math.pow(1024, i)).toFixed(2) + ' ' + sizes[i];
}
async function loadFilesForActiveFolder() {
	filesBodyEl.innerHTML = '';
	if(activeFolderIndex < 0 || !folders[activeFolderIndex]) {
		filesBodyEl.innerHTML = `<tr><td colspan="5" class="empty">Select a folder...</td></tr>`;
		return;
	}
	const ids = folders[activeFolderIndex].files || [];
	if(ids.length === 0) {
		filesBodyEl.innerHTML = `<tr><td colspan="5" class="empty">No files in this folder.</td></tr>`;
		return;
	}
	setStatus('Loading files...');
	for(const id of ids) {
		try {
			const meta = await storage.getFile(APPWRITE_BUCKET_ID, id);
			const tr = document.createElement('tr');
			const downloadUrl = storage.getFileDownload(APPWRITE_BUCKET_ID, id);
			tr.innerHTML = ` <td>${meta.name || '(unnamed)'}</td> <td class="muted">${meta.$id}</td> <td>${formatBytes(meta.sizeOriginal || meta.size || 0)}</td> <td>${new Date(meta.$createdAt || meta.dateCreated || Date.now()).toLocaleString()}</td> <td> <a href="${downloadUrl}" target="_blank" rel="noopener">Download</a> &nbsp;|&nbsp; <a href="#" data-id="${id}" class="delete-file">Delete</a> </td> `;
			filesBodyEl.appendChild(tr);
		} catch (e) {
			const tr = document.createElement('tr');
			tr.innerHTML = ` <td colspan="5" class="muted">Failed to load file ${id}: ${e.message}</td> `;
			filesBodyEl.appendChild(tr);
		}
	}
	filesBodyEl.querySelectorAll('.delete-file').forEach(a => {
		a.addEventListener('click', async (e) => {
			e.preventDefault();
			const id = e.target.getAttribute('data-id');
			await deleteFile(id);
		});
	});
	setStatus('Ready');
}

function makeCustomIdFromFile(file) {
	const base = file.name.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9._-]/g, '').toLowerCase();
	const ts = Date.now().toString(36);
	return `${ts}-${base}`.slice(0, 128);
}
async function uploadFile() {
	if(activeFolderIndex < 0) {
		alert('Select a folder');
		return;
	}
	const file = fileInputEl.files[0];
	if(!file) {
		alert('Choose a file');
		return;
	}
	let fileId = customFileIdEl.value.trim();
	if(!fileId) fileId = makeCustomIdFromFile(file);
	setStatus('Uploading...');
	let created;
	try {
		created = await storage.createFile(APPWRITE_BUCKET_ID, Appwrite.ID.custom(fileId), file);
	} catch (e) {
		alert('Upload failed: ' + e.message);
		setStatus('Upload failed');
		return;
	}
	try {
		const f = folders[activeFolderIndex];
		if(!Array.isArray(f.files)) f.files = [];
		if(!f.files.includes(created.$id)) f.files.push(created.$id);
		await saveFolders();
		renderFoldersList();
		renderFolderSelect();
		await loadFilesForActiveFolder();
		fileInputEl.value = '';
		customFileIdEl.value = '';
		setStatus('Upload complete');
	} catch (e) {
		alert('Uploaded, but failed to sync folder list: ' + e.message);
		setStatus('Sync error');
	}
}
async function deleteFile(fileId) {
	if(!confirm(`Delete file ${fileId}?`)) return;
	setStatus('Deleting file...');
	try {
		await storage.deleteFile(APPWRITE_BUCKET_ID, fileId);
	} catch (e) {
		alert('Failed to delete file in Appwrite: ' + e.message);
		setStatus('Delete failed');
		return;
	}
	try {
		const f = folders[activeFolderIndex];
		f.files = (f.files || []).filter(id => id !== fileId);
		await saveFolders();
		await loadFilesForActiveFolder();
		setStatus('File deleted');
	} catch (e) {
		alert('Deleted from storage, but failed to update folder: ' + e.message);
		setStatus('Partial delete');
	}
}
btnCreateFolderEl.addEventListener('click', createFolder);
newFolderNameEl.addEventListener('keydown', (e) => {
	if(e.key === 'Enter') createFolder();
});
btnUploadEl.addEventListener('click', uploadFile);
(async function init() {
	try {
		await fetchFolders();
	} catch (e) {
		alert('Failed to load folders from JSONBin: ' + e.message);
	}
	renderFoldersList();
	renderFolderSelect();
	if(folders.length > 0) {
		activeFolderIndex = 0;
		renderFoldersList();
		renderFolderSelect();
		loadFilesForActiveFolder();
	}
	setStatus('Ready');
})();
</script>
</body>

</html>
